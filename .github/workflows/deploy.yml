name: Deploy to Production

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run final tests before deployment
      run: |
        python -m pytest || true
    
    - name: Build application package
      run: |
        mkdir -p dist
        tar -czf dist/healthcare-app-${{ github.sha }}.tar.gz \
          app.py model.py requirements.txt templates/ static/ \
          --exclude='__pycache__' \
          --exclude='.venv' \
          --exclude='.git'
        echo "âœ“ Package created: healthcare-app-${{ github.sha }}.tar.gz"
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      with:
        name: healthcare-app-build
        path: dist/
        retention-days: 30
    
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: Release ${{ github.ref }}
        body: |
          ## Production Deployment
          - Automated deployment from CI/CD pipeline
          - Build: ${{ github.sha }}
          - Branch: ${{ github.ref_name }}
          
          ### Changes
          - Healthcare app v${{ github.ref_name }}
          - All tests passed
          - Security checks completed
        draft: false
        prerelease: false
    
    - name: Deployment Notification
      run: |
        echo "ðŸ“¦ Deployment Package Ready"
        echo "SHA: ${{ github.sha }}"
        echo "Ref: ${{ github.ref }}"
        echo "Build completed and ready for deployment"
